# Production Google OAuth "Unable to exchange external code" Fix

## Error
```
error=server_error
error_code=unexpected_failure
error_description=Unable+to+exchange+external+code
```

This error occurs when Supabase receives the OAuth code from Google but cannot exchange it for tokens.

## Root Causes

1. **Incorrect Client Secret in Supabase Dashboard** (Most Common)
2. **Missing or incorrect redirect URI in Google Cloud Console**
3. **OAuth code expired** (codes expire in 1-2 minutes)
4. **Mismatched OAuth client configuration**

## Step-by-Step Fix

### Step 1: Verify Google Cloud Console Configuration

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Select your project
3. Navigate to **APIs & Services** → **Credentials**
4. Find your OAuth 2.0 Client ID
5. Click **Edit**

#### Check Authorized Redirect URIs

Ensure you have **BOTH** of these redirect URIs:

1. **Supabase callback** (required):
   ```
   https://YOUR_PROJECT_REF.supabase.co/auth/v1/callback
   ```
   - Replace `YOUR_PROJECT_REF` with your Supabase project reference ID
   - To find it: Supabase Dashboard → Settings → General → Reference ID

2. **Your app callback** (optional but recommended):
   ```
   https://stavky.vercel.app/auth/callback
   ```

**Important**: The Supabase callback URI is the one Google uses first. Your app callback is where Supabase redirects after handling OAuth.

#### Copy Client Credentials

1. In Google Cloud Console, copy:
   - **Client ID** (e.g., `123456789-abc.apps.googleusercontent.com`)
   - **Client Secret** (e.g., `GOCSPX-xxxxx`)

2. **Important**: Make sure you're copying the **Client Secret**, not the Client ID again

### Step 2: Verify Supabase Dashboard Configuration

1. Go to [Supabase Dashboard](https://app.supabase.com)
2. **IMPORTANT**: Select your **PRODUCTION** project (not local/staging)
3. Navigate to **Authentication** → **Providers**
4. Find **Google** in the list
5. Click **Enable** or the edit icon (pencil)

#### Verify Settings

1. **Client ID (for OAuth)**:
   - Should match exactly what's in Google Cloud Console
   - Should NOT be `env(GOOGLE_CLIENT_ID)` (that's for local only)

2. **Client Secret (for OAuth)**:
   - Should match exactly what's in Google Cloud Console
   - Should NOT be `env(GOOGLE_CLIENT_SECRET)` (that's for local only)
   - **This is the most common issue** - if wrong, OAuth exchange fails

3. **Redirect URL** (shown in Supabase):
   - Should be: `https://YOUR_PROJECT_REF.supabase.co/auth/v1/callback`
   - This is auto-generated by Supabase - don't change it

4. Click **Save**

### Step 3: Verify Supabase URL Configuration (CRITICAL)

1. In Supabase Dashboard, go to **Authentication** → **URL Configuration**

2. **Site URL**:
   - Should be: `https://stavky.vercel.app`
   - **NOT** `http://localhost:3000`
   - **NOT** `https://stavky.vercel.app/en` (no locale prefix)

3. **Redirect URLs** (MOST IMPORTANT - This fixes the `/en/auth/v1/callback` error):
   - **MUST include**: `https://stavky.vercel.app/auth/callback`
   - **DO NOT include**: `https://stavky.vercel.app/auth/v1/callback` (this is Supabase's internal endpoint)
   - **DO NOT include**: `https://stavky.vercel.app/en/auth/callback` (Supabase will add locale if needed)
   - Optional: `https://*.vercel.app/auth/callback` (for preview deployments)
   
   **Important**: The redirect URL must be exactly `/auth/callback` (not `/auth/v1/callback`). The `/v1/callback` path is Supabase's internal endpoint that Google uses. Your app's callback is `/auth/callback`.

4. Click **Save**
5. **Wait 1-2 minutes** for changes to propagate

### Step 4: Verify OAuth Consent Screen

1. In Google Cloud Console → **APIs & Services** → **OAuth consent screen**

2. Check:
   - **Publishing status**: Should be "In production" or "Testing"
   - If "Testing": Your email must be in **Test users** list
   - **Authorized domains**: Should include `vercel.app` and your custom domain

3. If in Testing mode and your email is not listed:
   - Click **+ ADD USERS**
   - Add your email address
   - Save

### Step 5: Clear and Test

1. **Clear browser cache and cookies** for your production site
2. **Wait 1-2 minutes** for Supabase changes to propagate
3. Try OAuth login again

## Common Mistakes

### ❌ Wrong: Using localhost credentials in production
- Don't use `env(GOOGLE_CLIENT_ID)` in Supabase Dashboard
- Use actual values from Google Cloud Console

### ❌ Wrong: Missing Supabase redirect URI in Google
- Google must have: `https://YOUR_PROJECT_REF.supabase.co/auth/v1/callback`
- Without this, Google won't redirect back to Supabase

### ❌ Wrong: Client Secret mismatch
- Client Secret in Supabase must **exactly match** Google Cloud Console
- Even one character difference will cause this error

### ❌ Wrong: Using wrong Supabase project
- Make sure you're configuring the **production** Supabase project
- Not local, staging, or a different project

## Verification Checklist

- [ ] Google Cloud Console has Supabase redirect URI: `https://YOUR_PROJECT_REF.supabase.co/auth/v1/callback`
- [ ] Google Cloud Console has app redirect URI: `https://stavky.vercel.app/auth/callback`
- [ ] Supabase Dashboard Google provider has correct Client ID (actual value, not env var)
- [ ] Supabase Dashboard Google provider has correct Client Secret (actual value, not env var)
- [ ] Supabase Dashboard Site URL is `https://stavky.vercel.app` (not localhost)
- [ ] Supabase Dashboard Redirect URLs include production URLs
- [ ] OAuth consent screen is published or has test users
- [ ] Browser cache cleared
- [ ] Waited 1-2 minutes after making changes

## Quick Test

After making changes, test the OAuth flow:

1. Go to: `https://stavky.vercel.app/en/login`
2. Click "Sign in with Google"
3. **Expected**: Redirects to Google OAuth page
4. After authentication, **Expected**: Redirects back to your app successfully

If you still get the error:
- Double-check the Client Secret in Supabase Dashboard matches Google Cloud Console exactly
- Verify the redirect URI in Google Cloud Console includes the Supabase callback URL
- Check Supabase Dashboard logs for more detailed error messages

## Related Documentation

- [Google OAuth Dashboard Setup](GOOGLE_OAUTH_DASHBOARD_SETUP.md)
- [Production OAuth Redirect Fix](PRODUCTION_OAUTH_REDIRECT_FIX.md)
- [Supabase Google OAuth Fix](SUPABASE_GOOGLE_OAUTH_FIX.md)

